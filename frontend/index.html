<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSec AI Agent v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            border: 1px solid #374151; /* gray-700 */
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            border-color: #facc15; /* yellow-400 */
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 20px;
            border: 2px solid #1f2937; /* gray-800 */
        }
        .mitre-link {
            transition: color 0.2s;
        }
        .mitre-link:hover {
            color: #facc15; /* yellow-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
    
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white">DataSec AI Agent <span class="text-yellow-400">v3</span></h1>
            <p class="text-lg text-gray-400 mt-2">Análisis de Seguridad Autónomo a través de API</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Column: Input & Controls -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col">
                <div>
                    <h2 class="text-2xl font-semibold text-white mb-4">1. Contexto de la Aplicación</h2>
                    <p class="text-gray-400 mb-4">
                        Describe el ecosistema de tu aplicación. Puedes usar lenguaje natural o un formato semi-estructurado.
                    </p>
                    
                    <div class="mb-4">
                        <span class="text-sm font-medium text-gray-400 mr-2">Cargar ejemplo:</span>
                        <button class="example-btn text-sm bg-gray-700 hover:bg-gray-600 text-yellow-400 font-bold py-1 px-3 rounded" data-example="1">Gestión de Pagos</button>
                        <button class="example-btn text-sm bg-gray-700 hover:bg-gray-600 text-yellow-400 font-bold py-1 px-3 rounded" data-example="2">Consola de Empleados</button>
                    </div>

                    <textarea id="userInput" class="w-full h-80 bg-gray-900 border-2 border-gray-700 rounded-md p-3 text-gray-300 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition duration-200 resize-y text-sm" placeholder="Pega aquí la descripción de tu aplicación..."></textarea>
                </div>
                
                <button id="analyzeBtn" class="mt-6 w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="analyzeIcon" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    <span id="analyzeBtnText">Ejecutar Análisis</span>
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-900 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Right Column: Output -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">2. Reporte de Seguridad Generado</h2>
                <div id="outputContainer" class="h-[500px] overflow-y-auto pr-2">
                    <div id="placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-lg font-medium">El reporte aparecerá aquí.</p>
                        <p>Ingresa el contexto de tu aplicación y ejecuta el análisis.</p>
                    </div>
                    <div id="reportContent" class="hidden">
                        <!-- Report content will be dynamically injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIG & STATE ---
            const API_ENDPOINT = 'http://localhost:8000/analyze';

            // --- UI ELEMENTS ---
            const elements = {
                userInput: document.getElementById('userInput'),
                analyzeBtn: document.getElementById('analyzeBtn'),
                analyzeBtnText: document.getElementById('analyzeBtnText'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                analyzeIcon: document.getElementById('analyzeIcon'),
                outputContainer: document.getElementById('outputContainer'),
                placeholder: document.getElementById('placeholder'),
                reportContent: document.getElementById('reportContent'),
                exampleButtons: document.querySelectorAll('.example-btn')
            };

            // --- EXAMPLE DATA ---
            const examples = {
                "1": `Nombre: Internal Payments Hub
Uso:
- Permite a operadores, supervisores y auditores internos:
- Consultar pagos históricos de clientes y proveedores
- Aprobar, modificar o bloquear pagos de alto riesgo
- Ajustar límites diarios y mensuales de cuentas
- Desbloquear cuentas bajo investigación de fraude
APIs expuestas:
- /api/payments/submit: Registrar un nuevo pago desde Admin
- /api/payments/refund: Devolver un pago ante reclamo
- /api/account/limit-adjust: Cambiar límites operativos
- /api/account/audit-log: Descargar logs de actividad
Tecnologías:
- Backend Python+Django REST Framework
- Base de datos PostgreSQL cifrada
- Frontend React
- Autenticación SSO y Google Authenticator
Controles actuales:
- Logs de todas las acciones sensibles.
- Control de acceso basado en roles (pero roles algo amplios).
- Sin scoring automático de anomalías.`,
                "2": `Nombre: Employee Management Console
Uso:
- Permite a personal de RRHH, gerentes y administradores:
- Consultar, actualizar, dar de alta/baja perfiles de empleados.
- Descargar reportes de datos sensibles (DNI, datos bancarios).
APIs expuestas:
- /api/employees/get-details: Consultar información de un empleado
- /api/employees/update-profile: Modificar datos del perfil
- /api/access-management/grant: Otorgar o revocar accesos
- /api/reporting/export-data: Exportar datos sensibles en CSV/XLS
Tecnologías:
- Backend Java Spring Boot
- Base de datos Oracle con cifrado TDE
- Frontend Angular
- Autenticación LDAP corporativo + MFA opcional
Controles actuales:
- Logging de cambios sensibles.
- Acceso basado en roles estrictos (reportes masivos no limitados).
- No hay alertas sobre descargas inusuales.`
            };

            // --- UI FUNCTIONS ---
            function setLoadingState(isLoading) {
                elements.analyzeBtn.disabled = isLoading;
                elements.analyzeBtnText.classList.toggle('hidden', isLoading);
                elements.analyzeIcon.classList.toggle('hidden', isLoading);
                elements.loadingSpinner.classList.toggle('hidden', !isLoading);
            }

            function renderReport(data) {
                elements.placeholder.classList.add('hidden');
                
                let reportHTML = `<div class="space-y-6">`;
                
                // Summary Card
                reportHTML += `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-yellow-400 mb-2">${data.application_name}</h3>
                        <p class="text-gray-300 text-sm mb-2"><span class="font-semibold">Report ID:</span> ${data.report_id}</p>
                        <p class="text-gray-300">${data.summary}</p>
                    </div>
                `;

                // Detectors Title
                reportHTML += `<h3 class="text-2xl font-bold text-white pt-4 border-t border-gray-700">Detectores Priorizados</h3>`;

                // Detectors Cards
                data.prioritized_detectors.forEach(detector => {
                    const riskColor = {
                        'Alto': 'text-red-400',
                        'Medio': 'text-yellow-400',
                        'Bajo': 'text-green-400'
                    }[detector.risk_level] || 'text-gray-400';

                    reportHTML += `
                        <div class="card bg-gray-800 p-5 rounded-lg border border-gray-700 shadow-md">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="text-lg font-bold text-white flex-1 pr-4">${detector.priority}. ${detector.detector_name}</h4>
                                <span class="font-bold py-1 px-3 rounded-full text-sm ${riskColor}">${detector.risk_level}</span>
                            </div>
                            <p class="text-sm text-gray-400 mb-4"><strong>Vector de Amenaza:</strong> ${detector.threat_vector}</p>
                            
                            <div class="mb-4">
                                <h5 class="font-semibold text-gray-300 mb-2">Técnicas MITRE ATT&CK</h5>
                                <div class="flex flex-wrap gap-2">
                                    ${detector.mitre_techniques.map(tech => `
                                        <a href="https://attack.mitre.org/techniques/${tech.id.replace('.', '/')}" target="_blank" rel="noopener noreferrer" class="mitre-link text-xs bg-gray-700 text-gray-300 py-1 px-2 rounded-md hover:bg-gray-600">
                                            ${tech.id}: ${tech.name}
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-gray-900/50 p-3 rounded-md">
                                <h5 class="font-semibold text-gray-300 mb-2">Pasos Accionables</h5>
                                <ul class="list-disc list-inside text-gray-400 text-sm space-y-1">
                                    ${detector.actionable_steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });

                reportHTML += `</div>`;
                elements.reportContent.innerHTML = reportHTML;
                elements.reportContent.classList.remove('hidden');
            }

            function renderError(errorMessage) {
                elements.placeholder.classList.add('hidden');
                elements.reportContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center text-red-400">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-lg font-bold">Error en el Análisis</h3>
                        <p class="text-sm mt-2">${errorMessage}</p>
                    </div>
                `;
                elements.reportContent.classList.remove('hidden');
            }

            // --- EVENT LISTENERS ---
            elements.analyzeBtn.addEventListener('click', async () => {
                const userInputText = elements.userInput.value.trim();
                if (!userInputText) {
                    alert('Por favor, ingresa una descripción para tu aplicación.');
                    return;
                }

                setLoadingState(true);
                elements.placeholder.classList.remove('hidden');
                elements.reportContent.classList.add('hidden');

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ user_input_text: userInputText }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
                    }

                    const reportData = await response.json();
                    renderReport(reportData);

                } catch (error) {
                    console.error('Error al realizar el análisis:', error);
                    renderError(error.message);
                } finally {
                    setLoadingState(false);
                }
            });

            elements.exampleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const exampleId = button.dataset.example;
                    elements.userInput.value = examples[exampleId];
                    elements.userInput.dispatchEvent(new Event('input')); // Para frameworks que escuchen cambios
                });
            });

        });
    </script>
</body>
</html>